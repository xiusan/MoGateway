<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <title>充电记录</title>

    <link rel="shortcut icon" href="favicon.ico"> <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/font-awesome.min.css" rel="stylesheet">

    <!-- Data Tables -->
    <link href="css/plugins/dataTables/dataTables.bootstrap.css" rel="stylesheet">
    <link href="css/plugins/bootstrap-table/bootstrap-table.min.css" rel="stylesheet">

    <link href="css/animate.min.css" rel="stylesheet">
    <link href="css/style.min.css" rel="stylesheet">

    <script src="../js/cron/jquery.min.js"></script>
    <script src="../js/cron/bootstrap.min.js"></script>
    <script src="js/plugins/jeditable/jquery.jeditable.js"></script>
    <script src="js/plugins/dataTables/jquery.dataTables.js"></script>
    <script src="js/plugins/dataTables/dataTables.bootstrap.js"></script>
    <script src="js/content.min.js?v=1.0.0"></script>
    <script src="js/local/chrgeRecord/chrge_record.js"></script>

    <script src="../js/plugins/layer/laydate/laydate.js"></script>
    <script src="js/plugins/iCheck/icheck.min.js"></script>


    <script src="js/plugins/bootstrap-table/bootstrap-table.min.js"></script>
    <script src="js/plugins/bootstrap-table/bootstrap-table-mobile.min.js"></script>
    <script src="js/plugins/bootstrap-table/locale/bootstrap-table-zh-CN.min.js"></script>
    <script src="js/export/tableExport.js"></script>
    <script src="js/export/xlsx.full.min.js"></script>

</head>

<body class="gray-bg">
<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row">
        <div class="col-sm-4">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5 >充电度数</h5>
                    <div class="ibox-tools">

                    </div>
                </div>
                <div class="ibox-content" style="align-content: center">
                    <ul id="totalChargingKwh" class="unstyled">
                        <li ></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-sm-4">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>充电次数</h5>
                    <div class="ibox-tools">

                    </div>
                </div>
                <div class="ibox-content" style="align-content: center">
                    <ul id="chargeCount" class="unstyled">
                        <li ></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-sm-4">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>充电时长</h5>
                    <div class="ibox-tools">

                    </div>
                </div>
                <div class="ibox-content" style="align-content: center">
                    <ul id="totalChargingDttm" class="unstyled">
                        <li ></li>

                    </ul>
                </div>
            </div>
        </div>

    </div>
    <div class="row">
        <div class="col-sm-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>基本 <small>分类，查找</small></h5>
                    <div class="ibox-tools">

                    </div>
                </div>
                <div class="ibox-content">
                    <div class="col-sm-12" >
                        <form>
                        <select id="select-a" class="form-control m-b"  style="width:200px;margin-right:20px;float: left" name="account">
                            <option value="">设备号</option>
                        </select>
                        <input placeholder="车号" style="width:200px;margin-right:20px;float: left" class="form-control " type="text" id="select-b" name="carNumber">
                        <input placeholder="卡号" style="width:200px;margin-right:20px;float: left" class="form-control " type="text" id="select-c" name="cardNumber">
                        <input style="width:200px;margin-right:20px;float: left" class="form-control" id="start" name="startChargingDttm" placeholder="开始日期" onclick="laydate({istime: true, format: 'YYYY-MM-DD hh:mm:ss'})">
                        <input style="width:200px;margin-right:20px;float: left" class="form-control" id="end" name="endChargingDttm" placeholder="结束日期" onclick="laydate({istime: true, format: 'YYYY-MM-DD hh:mm:ss'})">

                        <button id="search_btn" style="margin-right:20px;" type="button" class="btn btn-w-m btn-success">查询</button>
                            <button type="button" id="download" style="margin-left:50px" id="btn_download" class="btn btn-w-m btn-success" onClick ="$('#charge-record-table').tableExport({ type: 'excel',exclude: '.bs-checkbox', escape: 'false' , fileName:'充电记录'})">数据导出</button>
                            <!--
                            <button id="exportExcel" style="margin-right:20px;" type="button" class="btn btn-w-m btn-success"  >导出</button>
                            -->
                        <button type="reset" style="margin-right:20px;" class="btn btn-w-m btn-default">重置</button>
                        </form>
                    </div>
                    <!-- 表格 -->
                        <table  class="table table-striped table-bordered table-hover TadataTables-example datable"  id="charge-record-table" ></table>
                </div>
                <div class="modal inmodal fade" id="myModal5" tabindex="-1" role="dialog"  aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">

                            <div class="modal-body">
                                <p><strong>H+</strong> 是一个完全响应式，基于Bootstrap3.3.6最新版本开发的扁平化主题，她采用了主流的左右两栏式布局，使用了Html5+CSS3等现代技术，她提供了诸多的强大的可以重新组合的UI组件，并集成了最新的jQuery版本(v2.1.1)，当然，也集成了很多功能强大，用途广泛的jQuery插件，她可以用于所有的Web应用程序，如网站管理后台，网站会员中心，CMS，CRM，OA等等，当然，您也可以对她进行深度定制，以做出更强系统。</p>
                            </div>

                            <div class="modal-footer">
                                <button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>
                                <button type="button" class="btn btn-primary">保存</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>





<script type="text/javascript">
    class BstpTable{
        constructor(obj) {
            this.obj=obj;
        }
        inint(){

            //---先销毁表格 ---
            this.obj.bootstrapTable('destroy');
            //---初始化表格,动态从服务器加载数据---
            this.obj.bootstrapTable({
                //【发出请求的基础信息】
                url: '/chargeRecord/chargeRecordList',
                method: 'post',
                contentType: "application/x-www-form-urlencoded",


                //【查询设置】
                queryParamsType:'',
                /**
                queryParams: function queryParams(params) {

                    var param = {
                        pageNumber: params.pageNumber,
                        pageSize: params.pageSize,
                        equipmentno:params.equipmentno,
                        Name:$('#select-a').val(),
                        Name:$('#select-b').val(),
                        Name:$('#select-c').val(),
                        Name:$('#select-d').val(),
                    };
                    for(var key in searchArgs){
                        param[key]=searchArgs[key]
                    }
                    return param;

                },
                */
                queryParams: queryParams,
                //【其它设置】
                locale:'zh-CN',//中文支持
                pagination: true,//是否开启分页（*）
                pageNumber:1,//初始化加载第一页，默认第一页
                pageSize: 10,//每页的记录行数（*）
                pageList: [10,50,100],//可供选择的每页的行数（*）
                sidePagination: "server", //分页方式：client客户端分页，server服务端分页（*）
                showRefresh:true,//刷新按钮
                dataType: "json",
                uniqueId: "id",
                sortable: true,
                sortOrder: "asc",                   //排序方式
                showColumns: true,                  //是否显示所有的列（选择显示的列）
                showRefresh: true,                  //是否显示刷新按钮
                //bFilter: true,     //过滤功能
                //bSort: true,     //排序功能
                showExport: true,
                exportDataType: 'all',
                exportTypes:[ 'csv', 'txt', 'sql', 'doc', 'excel', 'xlsx', 'pdf'],  //导出文件类型
                Icons:'glyphicon-export',




                responseHandler: function(res) {
                    return {
                        "total": res.data.recordsTotal,//总页数
                        "rows": res.data.list,   //数据
                      //  "sortColumnsName": res.sort,      //排序列名
                        //"sortOrder": res.order //排位命令（desc，asc）
                    };
                },
                //【设置列】
                columns: [
                    {
                        field: 'id',
                        checkbox:true,
                    },
                    {field: 'chargingRecordNo',title: '充电记录号',sortable: true, },
                    {field: 'equipmentNo',title: '设备号',sortable: true},
                    {field: 'carNumber',title: '车号',sortable: true},
                    {field: 'cardNumber',title: '卡号',sortable: true},
                    {field: 'startChargingDttm',title: '  开   始   充   电   时   间 &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp',sortable: true,
                        formatter:function (value,row,index) {
                            //日期时间戳转换
                            var time = new Date(value);
                            var y = time.getFullYear();//年
                            var m = time.getMonth() + 1;//月
                            var d = time.getDate();//日
                            var h = time.getHours();//时
                            var mm = time.getMinutes();//分
                            var s = time.getSeconds();//秒
                            if(y == "1970"){
                                return "-";
                            }
                            return y+"-"+getzf(m)+"-"+getzf(d)+" "+getzf(h)+":"+getzf(mm)+":"+getzf(s);
                        }
                    },  {field: 'endChargingDttm',title: ' 结 束 充 电 时 间 &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp',sortable: true,
                        formatter:function (value,row,index) {
                            //日期时间戳转换
                            var time = new Date(value);
                            var y = time.getFullYear();//年
                            var m = time.getMonth() + 1;//月
                            var d = time.getDate();//日
                            var h = time.getHours();//时
                            var mm = time.getMinutes();//分
                            var s = time.getSeconds();//秒
                            if(y == "1970"){
                                return "-";
                            }
                            return y+"-"+getzf(m)+"-"+getzf(d)+" "+getzf(h)+":"+getzf(mm)+":"+getzf(s);
                        }
                    },
                    {field: 'totalChargingDttm',title: '总充电时长',sortable: true,
                        formatter:function (value,row,index) {
                       // console.log('总充电时长'+value);
                            if(value == "-" || value == null || value == "null"){
                                return "-";
                            }
                            var theTime = parseInt(value);// 秒

                            var theTime1 = 0;// 分

                            var theTime2 = 0;// 小时

                            if(theTime > 60) {

                                theTime1 = parseInt(theTime/60);

                                theTime = parseInt(theTime%60);

                                if(theTime1 > 60) {

                                    theTime2 = parseInt(theTime1/60);

                                    theTime1 = parseInt(theTime1%60);

                                }

                            }

                            var result = ""+parseInt(theTime)+"秒";

                            if(theTime1 > 0) {

                                result = ""+parseInt(theTime1)+"分"+result;

                            }

                            if(theTime2 > 0) {

                                result = ""+parseInt(theTime2)+"小时"+result;

                            }

                            return result;
                        }
                    },
                    {field: 'startAmmeterNo',title: '开始电表数',sortable: true},
                    {field: 'entAmmeterNo',title: '结束电表数',sortable: true},
                    {field: 'totalChargingKwh',title: '总充电量(度)',sortable: true},
                    {field: 'startSoc',title: '开始SOC(%)',sortable: true},
                    {field: 'endSoc',title: '结束SOC(%)',sortable: true},
                    {field: 'totalSoc',title: '实充SOC(%)',sortable: true},
                    {field: 'endReason',title: '停止原因',sortable: true,
                        formatter:function (value,row,index) {
                            var str= value;
                            var ok = "自动";
                            var  no = "手动";
                            if(str == "1"){
                                return ok;
                            }
                            if(str == "0"){
                                return no;
                            }
                        }
                    },

                    {field: 'message',title: '相关报文',sortable: true,
                        formatter: actionFormatter},
                    {field: 'sharpStartChargingDttm',title: '开始充电时间(尖)',sortable: true,
                        formatter:function (value,row,index) {
                            //日期时间戳转换
                            var time = new Date(value);
                            var y = time.getFullYear();//年
                            var m = time.getMonth() + 1;//月
                            var d = time.getDate();//日
                            var h = time.getHours();//时
                            var mm = time.getMinutes();//分
                            var s = time.getSeconds();//秒
                            if(y == "1970"){
                                return "-";
                            }
                            return y+"-"+getzf(m)+"-"+getzf(d)+" "+getzf(h)+":"+getzf(mm)+":"+getzf(s);
                        }
                    },
                    {field: 'sharpEndChargingDttm',title: '结束充电时间(尖)',sortable: true,
                        formatter:function (value,row,index) {
                            //日期时间戳转换
                            var time = new Date(value);
                            var y = time.getFullYear();//年
                            var m = time.getMonth() + 1;//月
                            var d = time.getDate();//日
                            var h = time.getHours();//时
                            var mm = time.getMinutes();//分
                            var s = time.getSeconds();//秒
                            if(y == "1970"){
                                return "-";
                            }
                            return y+"-"+getzf(m)+"-"+getzf(d)+" "+getzf(h)+":"+getzf(mm)+":"+getzf(s);
                        }
                    },
                    {field: 'sharpStartAmmeterNo',title: '开始电表数(尖)',sortable: true},
                    {field: 'sharpEndAmmeterNo',title: '结束电表数(尖)',sortable: true},
                    {field: 'sharpTotalChargingKwh',title: '充电量(尖)',sortable: true},
                    {field: 'peakStartChargingDttm',title: '开始充电时间(峰)',sortable: true,
                        formatter:function (value,row,index) {
                            //日期时间戳转换
                            var time = new Date(value);
                            var y = time.getFullYear();//年
                            var m = time.getMonth() + 1;//月
                            var d = time.getDate();//日
                            var h = time.getHours();//时
                            var mm = time.getMinutes();//分
                            var s = time.getSeconds();//秒
                            if(y == "1970"){
                                return "-";
                            }
                            return y+"-"+getzf(m)+"-"+getzf(d)+" "+getzf(h)+":"+getzf(mm)+":"+getzf(s);
                        }
                    },
                    {field: 'peakEndChargingDttm',title: '结束充电时间(峰)',sortable: true,
                        formatter:function (value,row,index) {
                            //日期时间戳转换
                            var time = new Date(value);
                            var y = time.getFullYear();//年
                            var m = time.getMonth() + 1;//月
                            var d = time.getDate();//日
                            var h = time.getHours();//时
                            var mm = time.getMinutes();//分
                            var s = time.getSeconds();//秒
                            if(y == "1970"){
                                return "-";
                            }
                            return y+"-"+getzf(m)+"-"+getzf(d)+" "+getzf(h)+":"+getzf(mm)+":"+getzf(s);
                        }
                    },
                    {field: 'peakStartAmmeterNo',title: '开始电表数(峰)',sortable: true},
                    {field: 'peakEndAmmeterNo',title: '结束电表数(峰)',sortable: true},
                    {field: 'peakTotalChargingKwh',title: '充电量(峰)',sortable: true},
                    {field: 'flatStartChargingDttm',title: '开始充电时间(平)',sortable: true,
                        formatter:function (value,row,index) {
                            //日期时间戳转换
                            var time = new Date(value);
                            var y = time.getFullYear();//年
                            var m = time.getMonth() + 1;//月
                            var d = time.getDate();//日
                            var h = time.getHours();//时
                            var mm = time.getMinutes();//分
                            var s = time.getSeconds();//秒
                            if(y == "1970"){
                                return "-";
                            }
                            return y+"-"+getzf(m)+"-"+getzf(d)+" "+getzf(h)+":"+getzf(mm)+":"+getzf(s);
                        }
                    },
                    {field: 'flatEndChargingDttm',title: '结束充电时间(平)',sortable: true,
                        formatter:function (value,row,index) {
                            //日期时间戳转换
                            var time = new Date(value);
                            var y = time.getFullYear();//年
                            var m = time.getMonth() + 1;//月
                            var d = time.getDate();//日
                            var h = time.getHours();//时
                            var mm = time.getMinutes();//分
                            var s = time.getSeconds();//秒
                            if(y == "1970"){
                                return "-";
                            }
                            return y+"-"+getzf(m)+"-"+getzf(d)+" "+getzf(h)+":"+getzf(mm)+":"+getzf(s);
                        }
                    },
                    {field: 'flatStartAmmeterNo',title: '开始电表数(平)',sortable: true},
                    {field: 'flatEndAmmeterNo',title: '结束电表数(平)',sortable: true},
                    {field: 'flatTotalChargingKwh',title: '充电量(平)',sortable: true},
                    {field: 'valleyStartChargingDttm',title: '开始充电时间(谷)',sortable: true,
                        formatter:function (value,row,index) {
                            //日期时间戳转换
                            var time = new Date(value);
                            var y = time.getFullYear();//年
                            var m = time.getMonth() + 1;//月
                            var d = time.getDate();//日
                            var h = time.getHours();//时
                            var mm = time.getMinutes();//分
                            var s = time.getSeconds();//秒
                            if(y == "1970"){
                                return "-";
                            }
                            return y+"-"+getzf(m)+"-"+getzf(d)+" "+getzf(h)+":"+getzf(mm)+":"+getzf(s);
                        }
                    },
                    {field: 'valleyEndChargingDttm',title: '结束充电时间(谷)',sortable: true,
                        formatter:function (value,row,index) {
                            //日期时间戳转换
                            var time = new Date(value);
                            var y = time.getFullYear();//年
                            var m = time.getMonth() + 1;//月
                            var d = time.getDate();//日
                            var h = time.getHours();//时
                            var mm = time.getMinutes();//分
                            var s = time.getSeconds();//秒
                            if(y == "1970"){
                                return "-";
                            }
                            return y+"-"+getzf(m)+"-"+getzf(d)+" "+getzf(h)+":"+getzf(mm)+":"+getzf(s);
                        }
                    },
                    {field: 'valleyStartAmmeterNo',title: '开始电表数(谷)',sortable: true},
                    {field: 'valleyEndAmmeterNo',title: '结束电表数(谷)',sortable: true},
                    {field: 'valleyTotalChargingKwh',title: '充电量(谷)',sortable: true}
                ]
            })
        }
    }

    var bstpTable=new BstpTable($("table"));
    bstpTable.inint({})
    $('.fixed-table-header').remove();

    //操作栏的格式化
    function actionFormatter(value, row, index) {
        var message = value;
        var result = "";
        result += "<a href='javascript:;' class='btn btn-xs green' onclick=\"message('" + message + "', operateFlag='1')\"  title='查看'><span class='glyphicon '>查看</span></a>";
        return result;
    }

    //请求服务数据时所传参数
    function queryParams(params){
        return{
            pageNumber: params.pageNumber,
            pageSize: params.pageSize,
            equipmentNo:$("#select-a option:selected").val(),
            carNumber:$("input[name=carNumber]").val(),
            cardNumber:$("input[name=cardNumber]").val(),
            startChargingDate:$("input[name=startChargingDttm]").val(),
            endChargingDate:$("input[name=endChargingDttm]").val()
        }
    }




    //车号,卡号
    $(function(){
        number();
    })
    //设备号
    $(function(){
        equipmentNo();
    })

    //充电记录度数，次数，时长
    $(function(){
        chargeRecordCount();
    })


    //查询按钮事件
    $('#search_btn').click(function(){
        $('#charge-record-table').bootstrapTable('refresh', {url: '/chargeRecord/chargeRecordList'});
    })
    //导出
    $('#exportExcel').click(function(params){
            $.ajax({
                url :  '/chargeRecord/export',
                type : "post",
                contentType: "application/x-www-form-urlencoded; charset=utf-8",
                data : {
                    pageNumber: params.pageNumber,
                    pageSize: params.pageSize,
                    equipmentNo:$("#select-a option:selected").val(),
                    carNumber:$("input[name=carNumber]").val(),
                    cardNumber:$("input[name=cardNumber]").val(),
                    startChargingDate:$("input[name=startChargingDttm]").val(),
                    endChargingDate:$("input[name=endChargingDttm]").val()
                },
                success : function (data) {
                    if(data != null){
                        parent.layer.alert("导出成功！");
                    }else if(data.code == "excel1001"){
                        parent.layer.alert(data.message);
                    }else{
                        parent.layer.alert("导出失败！");
                    }
                }
            });
    })


    //补0操作
    function getzf(num){
        if(parseInt(num) < 10){
            num = '0'+num;
        }
        return num;
    }

    //查看报文

     function message(message,operateFlag){
            //console.log(message)
            if(message=="null"){
                message = "";
            }
            parent.layer.open({
                type: 1,
                btn: ['确定','取消'], //按钮
                shift: 2,
                shadeClose: true, //开启遮罩关闭
                skin: 'layui-layer-rim', //加上边框
                area: ['420px', '240px'], //宽高
                content: message
            });
        }


</script>

</body>

</html>
